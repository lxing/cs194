<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>
<body>
<div id="option">
  <input name="forceButton"
   type="button"
   value="Force"
   onclick="forceToggle()"/>
  <input name="authorSliceButton"
    type="button"
    value="AuthorSlice"
    onclick="sliceByAuthor()"/>
  <input name="cosineSimilarSliceButton"
    type="button"
    value="CosineSimilarSlice"
    onclick="sliceByCosineSimilarity()"/>
  <form onkeypress="return event.keyCode != 13;">
    <input name="textSearchBox"
           type="text">
    <input type="button"
           value="Search"
           onclick="searchByText(this.form)"
           onkeypress="searchByText(this.form)">
  </form>
</div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-latest.min.js"
        type="text/javascript"></script>
<script>

var width = 800,
    height = 600;

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-120)
    .linkDistance(120)
    .size([width, height]);

d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
  this.parentNode.appendChild(this);
  });
};

var contextMenuShowing = false;
var selectedNode = null;

var svg = d3.select("body").append("div")
    .attr("id", "graph")
    .style("float", "left")
    .style("width", width + "px")
      .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("clip-path", "url(#clip")
        .call(d3.behavior.zoom().scaleExtent([-8, 8])
        .on("zoom", zoom))
        .on("dblclick.zoom", null);

var text = d3.select("body").append("div")
    .attr("id", "text")
    .style("float", "right")
    .style("width", width + "px");

svg.append("rect")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "overlay")
    .style("fill", "blue")
    .style("fill-opacity", 0)
    .style("stroke", "black")
    .style("stroke-width", 2)
    .style("stroke-opacity", .7);

text.append("rect")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "overlay")
    .style("fill", "blue")
    .style("fill-opacity", 0)
    .style("stroke", "black")
    .style("stroke-width", 2)
    .style("stroke-opacity", .7);

var innerSvg = svg.append("g");
var innerText = text.append("g")
    .append("textarea")
      .attr("wrap", "hard")
      .style("font-size", "14pt")
      .style("font-family", "Arial")
      .style("width", width + "px")
      .style("height", height + "px")
      .text("Roger");;

var authorSlice;
var cosineSimlaritySlice;
$.get("http://localhost:5000/authors", function(authors) {
  $.get("http://localhost:5000/documents", function(documents) {
    $.get("http://localhost:5000/relationships/AuthoredBy", function(authoredBy) {
      $.get("http://localhost:5000/relationships/SimilarTo", function(similarTo) {
        // console.log(documents);
        // var i=0;
        // for(;i<documents.length; ++i) {
        //   console.log(Object.keys(documents[i]));
        // }
        authorSlice = createAuthoredByLinks(authors, documents, authoredBy);
        cosineSimlaritySlice = createSimilarToLinks(documents, similarTo);
        loadVisualization(authorSlice[0], authorSlice[1]);
      })
    })
  })
});

function createAuthoredByLinks(authors, documents, relationships) {
  var i = 0;
  var nodes = [];
  var authorIndices = {};
  for (; i<authors.length; ++i) {
    author = authors[i];
    authorIndices[author["uuid"]] = i;
    nodes.push(author);
  }

  var documentIndices = {};
  for (j=0; j<documents.length; ++j) {
    doc = documents[j];
    documentIndices[doc["uuid"]] = i+j;
    nodes.push(doc);
  }

  var links = [];
  for (i=0; i<relationships.length; ++i) {
    var relation = relationships[i];
    sourceIndex = documentIndices[relation.start];
    targetIndex = authorIndices[relation.end];

    links.push( {
      source: sourceIndex,
      target: targetIndex,
      weight: 5
    });
  }
  return [nodes, links];
}

function createSimilarToLinks(documents, relationships) {
  var i = 0;
  var nodes = [];
  var documentIndices = {};
  for (j=0; j<documents.length; ++j) {
    doc = documents[j];
    documentIndices[doc["uuid"]] = i+j;
    nodes.push(doc);
  }

  var links = [];
  for (i=0; i<relationships.length; ++i) {
    var relation = relationships[i];
    sourceIndex = documentIndices[relation.start];
    targetIndex = documentIndices[relation.end];

    var weight = relation.weight;

    links.push( {
      source: sourceIndex,
      target: targetIndex,
      weight: weight
    });
  }
  return [nodes, links];
}
// loadVisualization();
function loadVisualization(nodes, links) {
  force.nodes(nodes)
       .links(links)
       .start();

  var drag = force.drag()
      .on("dragstart", dragstart)
      .on("dragend", dragend);

  var link = innerSvg.selectAll("g.link")
      .data(links)
      .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.weight); });

  var gnodes = innerSvg.selectAll('g.gnode')
    .data(nodes);

  var enterNode = gnodes.enter().append("g")
    .classed('gnode', true)
    .on("mouseover", function(d){
          if (d.type == "author") {
            d3.select(this).append("text")
              .text(d.name);
            }
          if (d.type == "document") {
            d3.select(this).append("text")
              .text(d.title);
          }
        })
    .on("mouseout", function(d) {
          d3.select(this).select("text").remove();
        })
    .on('contextmenu', function(d) {
          if(contextMenuShowing) {
            d3.event.preventDefault();
            d3.select(".popup").remove();
            d3.select(".foreignObject").remove();
            contextMenuShowing = false;
          } else {
            d3.event.preventDefault();
            contextMenuShowing = true;
            selectedNode = d;

            mousePosition = [d3.event.x, d3.event.y];
            foreignObj = d3.select(this).append("foreignObject")
                .attr("width", 300)
                .attr("height", 600);
            foreignObj.moveToFront();

            popup = foreignObj.append("xhtml:div")
                .attr("class", "popup")
                .style("background-color", "azure")
            var keys = Object.keys(d);
            for (var i=0; i<keys.length; ++i) {
              var key = keys[i];
              if (key!="uuid" && key!="index" && key!="weight" &&
                  key!="x" && key!="y" && key!="px" && key!="py" && key!="body" &&
                  key!="fixed") {
                popup.append("p")
                .append("a")
                .attr("href", key)
                .text(keys[i] + ": " + d[key]); 
              }
            }

            form = popup.append("form");
            form.append("input")
                .attr("type", "text")
                .attr("name", "name");
            form.append("input")
                .attr("type", "button")
                .attr("value", "Submit")
                .attr("onclick", "updateNode()");

            innerText.text(d["body"]);
          }

    });

  var node = gnodes.append("circle")
      .attr("class", "node")
      .attr("r", 5)
      .style("fill", function(d) {
        if (d.type == "author") {
          return "#99CCFF";
        }
        return color(d.group);
      })
      .on("dblclick", dblclick)
      .call(drag);
  
  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    gnodes.attr("transform", function(d) { 
        return 'translate(' + [d.x, d.y] + ')';
    });
});

  function dblclick(d) {
    d3.select(this)
      .classed("fixed", d.fixed = false)
      .attr("r", 5);
  }

  function dragstart(d) {
    zoomBool = false;
    d3.select(this)
        .classed("fixed", d.fixed = true)
        .attr("r", 8);
  }

  function dragend(d) {
    zoomBool = true;
  }
}

var forceBool = true;
function forceToggle() {
  if (forceBool == true) {
    force.start();
    forceBool = false;
  } else {
    force.stop();  
    forceBool = true;
  }
}

function sliceByAuthor() {
  innerSvg.remove();
  innerSvg = svg.append("g");
  loadVisualization(authorSlice[0], authorSlice[1]);
}

function sliceByCosineSimilarity() {
  innerSvg.remove();
  innerSvg = svg.append("g");
  loadVisualization(cosineSimlaritySlice[0], cosineSimlaritySlice[1]);
}

function searchByText(form) {
  var queryText = form.textSearchBox.value;
  var gnodes = svg.selectAll("g.gnode");

  for (var j=0; j<gnodes.length; j++) {
    gnodesArr = gnodes[j];
    var gindexes = Object.keys(gnodesArr);
    for (var i=0; i<gindexes.length; ++i) {
      var gindex = gindexes[i];
      var gnode = gnodesArr[gindex];
      var gnodeKeys = Object.keys(gnode);
      for (var k=0; k<gnodeKeys.length; k++) {
        var key = gnodeKeys[k];
        if (key == "__data__") {
          var gnodeAttrs = gnode[key];
          var gnodeAttrKeys = Object.keys(gnodeAttrs);
          for (var d=0; d<gnodeAttrKeys.length; d++) {
            var gnodeAttrKey = gnodeAttrKeys[d];
            var searchText = gnodeAttrs[gnodeAttrKey] + "";
            if (searchText.indexOf(queryText) > -1) {
              d3.select(gnode).select("circle")
                .style("fill", function(d) {
                  return "RED";
                });
            }
          }
        }
      }
    }
  }


}

var zoomBool = true;
function zoom() {
  if (!zoomBool) return;
  var innerSvg = svg.selectAll("g");
  var link = svg.selectAll(".link");
  var gnodes = svg.selectAll(".node");
  innerSvg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
  force.start();
}

function updateNode() {
  selectedNode.name = "ROGER HAU";
}

</script>