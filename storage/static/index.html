<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>
<body>
<div id="option">
  <input name="forceButton"
   type="button"
   value="Force"
   onclick="forceToggle()"/>
</div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-latest.min.js"
        type="text/javascript"></script>
<script>

var width = 1600,
    height = 800;

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-240)
    .linkDistance(120)
    .size([width, height]);

d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
  this.parentNode.appendChild(this);
  });
};

var contextMenuShowing = false;
var selectedNode = null;

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

$.get("http://localhost:5000/authors", function(authors) {
  $.get("http://localhost:5000/relationships", function(relationships) {
    console.log(authors);
    console.log(relationships);

    links = createVisualLinks(authors, relationships);
    console.log(links);
    loadVisualization(authors, links);
  })
  
});

function createVisualLinks(authors, relationships) {
  var authorIndices = {}
  for (i=0; i<authors.length; ++i) {
    author = authors[i];
    authorIndices[author["uuid"]] = i;
  }

  var links = [];
  for (i=0; i<relationships.length; ++i) {
    var relation = relationships[i];
    sourceIndex = authorIndices[relation.start];
    targetIndex = authorIndices[relation.end];

    links.push( {
      source: sourceIndex,
      target: targetIndex
    });
  }
  return links;
}

// loadVisualization();
function loadVisualization(authors, links) {
  force.nodes(authors)
       .links(links)
       .start();

  var link = svg.selectAll(".link")
      .data(links)
      .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var gnodes = svg.selectAll('g.gnode')
    .data(authors);

  var nodeEnter = gnodes.enter().append("g")
    .classed('gnode', true)
    .on("mouseover", function(d){
          d3.select(this).append("text")
            .text(d.name);
        })
    .on("mouseout", function(d) {
          d3.select(this).select("text").remove();
        })
    .on('contextmenu', function(d) {
          if(contextMenuShowing) {
            d3.event.preventDefault();
            d3.select(".popup").remove();
            d3.select(".foreignObject").remove();
            contextMenuShowing = false;
          } else {
            console.log("ROGER HAU");
            d3.event.preventDefault();
            contextMenuShowing = true;
            selectedNode = d;

            mousePosition = [d3.event.x, d3.event.y];
            console.log(mousePosition);
            foreignObj = d3.select(this).append("foreignObject")
                .attr("width", 240)
                .attr("height", 500);
            foreignObj.moveToFront();

            popup = foreignObj.append("xhtml:div")
                .attr("class", "popup")
                .style("background-color", "azure")
            popup.append("h2").text(d.name);
            popup.append("p").text(d.name)
            popup.append("p")
                .append("a")
                .attr("href",d.name)
                .text(d.name); 
            form = popup.append("form");
            form.append("input")
                .attr("type", "text")
                .attr("name", "name")
            form.append("input")
                .attr("type", "button")
                .attr("value", "Submit")
                .attr("onclick", "updateNode()")
          }

    });

  var node = gnodes.append("circle")
      .attr("class", "node")
      .attr("r", 5)
      .style("fill", function(d) { return color(d.group); })
      .call(force.drag);

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    gnodes.attr("transform", function(d) { 
        return 'translate(' + [d.x, d.y] + ')'; 
    });
  });
}

// d3.select("body").on('contextmenu',function (d,i) {

// });

  var forceBool = false;
  function forceToggle() {
    if (forceBool == true) {
      force.start()
      forceBool = false;
    } else {
      force.stop();  
      forceBool = true;
    }
  }

  function updateNode() {
    console.log(selectedNode);
    selectedNode.name = "ROGER HAU";
  }

</script>